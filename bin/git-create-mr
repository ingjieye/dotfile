#!/bin/bash

# Check if target branch is provided
if [ -z "$1" ]; then
  echo "Error: Target branch not provided."
  echo "Usage: git create-mr <target-branch>"
  exit 1
fi

TARGET_BRANCH="$1"

# reviewers file:
# Alice
# Bob
# Charlie
# David
# ...
REVIEWERS_FILE="$HOME/.config/git/reviewers"
if [ -f "$REVIEWERS_FILE" ]; then
    REVIEWERS=$(paste -sd, "$REVIEWERS_FILE")
else
    echo "Warning: Reviewers file not found at $REVIEWERS_FILE. Creating MR without reviewers."
    REVIEWERS=""
fi

# Get current branch name
SOURCE_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ $? -ne 0 ]; then
    echo "Error: Could not get current Git branch. Make sure you are in a Git repository."
    exit 1
fi

echo "Source branch: $SOURCE_BRANCH"
echo "Target branch: $TARGET_BRANCH"
echo "Reviewers: $REVIEWERS"
echo "Creating merge request..."

# Use glab to create merge request
if [ -z "$REVIEWERS" ]; then
    glab mr create --source-branch "$SOURCE_BRANCH" --target-branch "$TARGET_BRANCH" --fill --yes
else
    glab mr create --source-branch "$SOURCE_BRANCH" --target-branch "$TARGET_BRANCH" --reviewer "$REVIEWERS" --fill --yes
fi

if [ $? -eq 0 ]; then
  echo "Merge request created successfully!"
else
  echo "Failed to create merge request."
fi